# Dot Plate Generator 設計ドキュメント

## 1. 概要

Dot Plate Generatorは、画像から3Dドットプレート（ピクセルアート風の立体物）を生成するためのデスクトップアプリケーションです。元の画像をドット絵風に変換し、それを3D STLファイルとしてエクスポートすることができます。

## 2. 主要機能

### 2.1 画像処理機能

- 画像のインポート (PNG, JPG, JPEG, GIF)
- 画像のリサイズと量子化 (ドット絵変換)
- 大型画像対応 (最大512x512)
- マンガ絵などの複雑な画像対応
- 複数の減色アルゴリズム
  - 単純量子化
  - メディアンカット法
  - K-means法
  - オクトツリー法
  - トゥーンアニメ風

### 2.2 編集機能

- ドットの色の編集（ペイント機能）
- 可変サイズブラシ（サイズ1〜10）
- 円形ブラシパターン
- 塗りつぶし機能
- スポイト機能
- 同じ色のドットの一括置換
- 編集履歴（元に戻す/やり直し）
- スクラッチから新規作成（プレビュークリア）

### 2.3 3Dモデル生成

- ドット絵からの3Dモデル生成
- 各種パラメータ調整（ドットサイズ、壁の高さなど）
- 壁の色の設定
- 同じ色のドット間の内壁省略オプション

### 2.4 プロジェクト管理

- プロジェクトファイルの保存/読み込み
- STLファイルのエクスポート

## 3. アーキテクチャ

### 3.1 技術スタック

- Python 3.x
- PyQt5 (GUIフレームワーク)
- PIL/Pillow (画像処理)
- NumPy (数値計算)
- scikit-image (画像処理)
- trimesh (3Dモデル生成)
- matplotlib (3D可視化)

### 3.2 ファイル構造

- `dot_plate_generator_gui.py`: メインアプリケーションコード
- `*.dpp`: プロジェクトファイル（JSONフォーマット）
- `input/`: 入力画像ディレクトリ（オプション）
- 出力STLファイル（ユーザー指定の場所）

## 4. ユーザーインターフェース

### 4.1 メインウィンドウ

3カラムレイアウト:
1. 左カラム: パラメータと設定パネル
2. 中央カラム: プレビューと編集ツール
3. 右カラム: STLプレビューと情報

### 4.2 メニューバー

- ファイルメニュー
  - 画像を開く
  - プロジェクトを開く
  - プロジェクトを保存
  - STLファイルを出力
  - 終了
- 編集メニュー
  - 元に戻す
  - やり直し
  - プレビューをクリア

### 4.3 パラメータパネル

- 画像読み込みセクション
- サイズ設定
  - Grid Size: ドット絵のピクセル数（最大512x512）
  - Dot Size: 各ドットの物理的なサイズ
  - Wall Thickness: 壁の厚さ
  - Wall Height: 壁の高さ
  - Base Height: ベースの高さ
  - Out Thickness: 外壁の厚さ
- 色設定
  - Color Step: 色量子化のステップサイズ
  - Top Colors: 使用する色の数
  - 減色アルゴリズム選択
  - 壁の色設定
  - 同じ色のドット間の内壁省略オプション
- 編集ツール設定
  - Brush Size: ブラシサイズ（1〜10）

### 4.4 プレビューパネル

- ドット絵プレビュー表示
- ペイントツール
  - ペイントモード
  - 塗りつぶしモード
  - 選択モード
- カラーピッカー
- スポイトツール
- 透明化ツール
- ズームコントロール
- プレビュークリアボタン
- ブラシサイズ調整スライダー（1〜10）

### 4.5 STLプレビューパネル

- 3Dモデルのプレビュー
- 色情報表示

## 5. データモデル

### 5.1 アプリケーション状態

- `image_path`: 元画像のファイルパス
- `pixels_rounded_np`: 処理済みピクセルデータ (NumPy配列)
- `current_grid_size`: ドット絵の解像度
- `current_color_algo`: 選択された減色アルゴリズム
- `zoom_factor`: ズームレベル
- `edit_history`: 編集履歴
- `wall_color`: 壁の色
- 各種パラメータ値 (コントロールの値)

### 5.2 プロジェクトファイル (DPP)

JSONフォーマットで以下を保存:
- バージョン情報
- 画像パス
- 各種パラメータ値
- ピクセルデータ (Base64エンコード)
- 壁の色
- 同色マージオプション状態
- 最新の編集履歴

## 6. 画像処理アルゴリズム

### 6.1 単純量子化

1. 各RGB値を指定されたステップサイズで丸める
2. 色の出現頻度を数える
3. 最も頻度の高い色を指定数選択
4. 各ピクセルを最も近い選択色にマッピング

### 6.2 メディアンカット法

1. 色空間を再帰的に分割
2. 各領域の代表色を選択
3. 各ピクセルを最も近い代表色にマッピング

### 6.3 K-means法

1. RGB色空間でK-meansクラスタリングを実行
2. クラスタの中心を代表色として選択
3. 各ピクセルを最も近いクラスタにマッピング

### 6.4 オクトツリー法

1. 色空間をオクトツリーに再帰的に分割
2. ツリーのノードを結合して代表色を選択
3. 各ピクセルを最も近い代表色にマッピング

### 6.5 トゥーンアニメ風

1. 画像をHSV色空間に変換
2. 高彩度の色を優先して主要な色相を特定
3. 各色相に対して3トーン（ベース、シャドウ、ハイライト）を生成
4. 黒と白を必ず含める
5. 各ピクセルを最も近い色にマッピング

## 7. 3Dモデル生成

### 7.1 ドットモデルの生成

1. 各ドットの3D座標を計算
2. ドットの色に基づいて内部構造を決定
3. 壁とベースを生成
4. 同色ドット間の内壁省略（オプション）
5. 各部分を統合して単一のメッシュを作成

### 7.2 STL出力

1. 3Dモデルをtrimeshを使用してSTLフォーマットに変換
2. ファイルに保存

## 8. 拡張機能とユースケース

### 8.1 主要ユースケース

1. **既存画像からのドットプレート生成**
   - 画像を読み込む
   - パラメータを調整
   - 必要に応じて個別ドットを編集
   - STL出力

2. **スクラッチからのドット絵作成**
   - 画像を読み込む（基準として）
   - プレビューをクリア
   - ドット絵を手動で描画
   - STL出力

3. **プロジェクトの保存と再開**
   - 作業中のプロジェクトを保存
   - 後日プロジェクトを読み込んで作業を継続

### 8.2 拡張機能

- アニメーションGIF対応
- カスタムパレットの保存と読み込み
- バッチ処理モード
- 複数レイヤー対応

## 9. パフォーマンスと制約

- 最大グリッドサイズ: 実用的なパフォーマンスのために制限あり
- STLファイルサイズ: 詳細なモデルでは大きくなる可能性
- 必要メモリ: 高解像度の場合、多くのメモリを消費

## 10. 今後の改善点

- マルチスレッド処理による高速化
- GPUアクセラレーション
- UI/UXの改善
- アニメーションGIFから3Dアニメーションへの対応
- テクスチャマッピングオプション